{% extends "base.html" %}

{% block title %}çˆ¬è™«æ§åˆ¶ - AI Crawler{% endblock %}

{% block content %}
<div class="page-header fade-in-up">
    <h1 class="page-title">çˆ¬è™«æ§åˆ¶</h1>
    <p class="page-subtitle">å¯åŠ¨å’Œç›‘æ§ AI çˆ¬å–ä»»åŠ¡ï¼Œæ”¯æŒå¤šå¹³å°æ™ºèƒ½æœç´¢</p>
</div>

<div class="row g-4">
    <!-- Control Panel -->
    <div class="col-lg-5">
        <div class="card fade-in-up" style="animation-delay: 0.1s;">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-sliders me-2" style="font-size: 20px; color: var(--accent-color);"></i>
                <h5 class="mb-0">æ§åˆ¶é¢æ¿</h5>
            </div>
            <div class="card-body">
                <!-- AI Provider Selection -->
                <div class="mb-4">
                    <label class="form-label">é€‰æ‹© AI å¹³å°</label>
                    <div class="provider-select-group">
                        <div class="provider-option selected" data-provider="deepseek"
                            onclick="selectProvider('deepseek')">
                            <i class="bi bi-robot" style="color: #764ba2;"></i>
                            <div class="name">DeepSeek</div>
                            <div class="desc">æ·±åº¦æ±‚ç´¢</div>
                        </div>
                        <div class="provider-option" data-provider="doubao" onclick="selectProvider('doubao')">
                            <i class="bi bi-lightning-charge" style="color: #10b981;"></i>
                            <div class="name">è±†åŒ…</div>
                            <div class="desc">æµè§ˆå™¨é‡‡é›†<span class="feature-badge"><i class="bi bi-display"></i>Playwright</span></div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©ä»»åŠ¡</label>
                    <select class="form-select" id="job-select">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">è¿è¡Œæ¨¡å¼</label>
                    <select class="form-select" id="mode-select">
                        <option value="new">ğŸ†• æ–°å»ºè¿è¡Œ (å¤„ç†æ‰€æœ‰å…³é”®è¯)</option>
                        <option value="resume">â–¶ï¸ æ¢å¤è¿è¡Œ (ç»§ç»­æœªå®Œæˆçš„)</option>
                        <option value="rerun">ğŸ”„ é‡æ–°è¿è¡Œ (é‡æ–°å¤„ç†æ‰€æœ‰)</option>
                    </select>
                </div>
                <div class="mb-4" id="location-group" style="display: none;">
                    <label class="form-label">è™šæ‹Ÿåœ°ç‚¹</label>
                    <select class="form-select" id="location-select">
                        <option value="">ä¸è®¾ç½® (ä½¿ç”¨é»˜è®¤)</option>
                        <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                        <option value="åŒ—äº¬">åŒ—äº¬</option>
                        <option value="å¹¿å·">å¹¿å·</option>
                        <option value="æ·±åœ³">æ·±åœ³</option>
                        <option value="æ­å·">æ­å·</option>
                        <option value="æˆéƒ½">æˆéƒ½</option>
                        <option value="æ­¦æ±‰">æ­¦æ±‰</option>
                        <option value="å—äº¬">å—äº¬</option>
                        <option value="é‡åº†">é‡åº†</option>
                        <option value="è¥¿å®‰">è¥¿å®‰</option>
                        <option value="è‹å·">è‹å·</option>
                        <option value="å¤©æ´¥">å¤©æ´¥</option>
                    </select>
                    <div class="form-text">é€šè¿‡ Playwright åœ°ç†ä½ç½®æ¬ºéª—ï¼Œä½¿è±†åŒ…è¿”å›å¯¹åº”åŸå¸‚çš„æœ¬åœ°åŒ–ç»“æœ</div>
                </div>
                <div class="d-grid gap-3">
                    <button class="btn btn-success btn-lg" id="start-btn">
                        <i class="bi bi-play-fill me-2"></i>å¯åŠ¨çˆ¬è™«
                    </button>
                    <button class="btn btn-danger btn-lg" id="stop-btn" disabled>
                        <i class="bi bi-stop-fill me-2"></i>åœæ­¢çˆ¬è™«
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Card -->
        <div class="card mt-4 fade-in-up" style="animation-delay: 0.2s;">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-activity me-2" style="font-size: 20px; color: var(--success-color);"></i>
                <h5 class="mb-0">è¿è¡ŒçŠ¶æ€</h5>
                <span class="badge-status badge-success ms-auto" id="status-badge">ç©ºé—²</span>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="p-3 rounded-3" style="background: rgba(124, 58, 237, 0.1);">
                            <div class="text-secondary mb-1" style="font-size: 12px;">å½“å‰ä»»åŠ¡</div>
                            <div id="current-job" style="font-weight: 600;">-</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 rounded-3" style="background: rgba(16, 185, 129, 0.1);">
                            <div class="text-secondary mb-1" style="font-size: 12px;">ä½¿ç”¨å¹³å°</div>
                            <div id="current-provider" style="font-weight: 600;">-</div>
                        </div>
                    </div>
                </div>

                <table class="table table-borderless mb-0" style="font-size: 14px;">
                    <tr>
                        <td class="text-secondary py-2" style="width: 100px;">å…³é”®è¯</td>
                        <td id="current-keyword" class="py-2" style="font-weight: 500;">-</td>
                    </tr>
                    <tr>
                        <td class="text-secondary py-2">è¿›åº¦</td>
                        <td id="progress-text" class="py-2" style="font-weight: 500;">0 / 0</td>
                    </tr>
                    <tr>
                        <td class="text-secondary py-2">ç»“æœ</td>
                        <td class="py-2">
                            <span class="text-success" style="font-weight: 600;"><i
                                    class="bi bi-check-circle me-1"></i><span id="success-count">0</span></span>
                            <span class="mx-2 text-secondary">/</span>
                            <span class="text-danger" style="font-weight: 600;"><i class="bi bi-x-circle me-1"></i><span
                                    id="fail-count">0</span></span>
                        </td>
                    </tr>
                </table>

                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-secondary" style="font-size: 12px;">å¤„ç†è¿›åº¦</span>
                        <span class="text-secondary" style="font-size: 12px;" id="progress-percentage">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Panel -->
    <div class="col-lg-7">
        <div class="card h-100 fade-in-up" style="animation-delay: 0.3s;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-terminal me-2" style="font-size: 20px; color: var(--info-color);"></i>
                    <h5 class="mb-0">è¿è¡Œæ—¥å¿—</h5>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                    <i class="bi bi-trash3 me-1"></i>æ¸…ç©º
                </button>
            </div>
            <div class="card-body p-0">
                <div class="log-container" id="log-container" style="height: 500px; border-radius: 0 0 20px 20px;">
                    <div class="log-entry text-secondary">
                        <i class="bi bi-hourglass me-2"></i>ç­‰å¾…å¯åŠ¨çˆ¬è™«...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const socket = io();
    let isRunning = false;
    let selectedProvider = 'deepseek';

    // Provider selection
    function selectProvider(provider) {
        selectedProvider = provider;
        document.querySelectorAll('.provider-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`[data-provider="${provider}"]`).classList.add('selected');
        // Show location dropdown only for doubao
        document.getElementById('location-group').style.display = provider === 'doubao' ? 'block' : 'none';
    }

    // Load jobs for select
    async function loadJobsSelect() {
        try {
            const res = await fetch('/api/jobs');
            const jobs = await res.json();

            const select = document.getElementById('job-select');
            if (jobs.length === 0) {
                select.innerHTML = '<option value="">æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»º</option>';
            } else {
                select.innerHTML = jobs.map(job =>
                    `<option value="${job.name}">${job.name} (${job.keywords_count}ä¸ªå…³é”®è¯)</option>`
                ).join('');
            }
        } catch (error) {
            console.error('Failed to load jobs:', error);
        }
    }

    // Update UI based on running state
    function updateUI(running) {
        isRunning = running;
        document.getElementById('start-btn').disabled = running;
        document.getElementById('stop-btn').disabled = !running;
        document.getElementById('job-select').disabled = running;
        document.getElementById('mode-select').disabled = running;
        document.getElementById('location-select').disabled = running;

        const statusBadge = document.getElementById('status-badge');
        if (running) {
            statusBadge.textContent = 'è¿è¡Œä¸­';
            statusBadge.className = 'badge-status badge-warning ms-auto pulse';
        } else {
            statusBadge.textContent = 'ç©ºé—²';
            statusBadge.className = 'badge-status badge-success ms-auto';
        }

        // Disable provider selection while running
        document.querySelectorAll('.provider-option').forEach(opt => {
            opt.style.pointerEvents = running ? 'none' : 'auto';
            opt.style.opacity = running ? '0.6' : '1';
        });
    }

    // Start crawler
    document.getElementById('start-btn').addEventListener('click', async () => {
        const jobName = document.getElementById('job-select').value;
        const mode = document.getElementById('mode-select').value;

        if (!jobName) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡');
            return;
        }

        // Update current provider display
        const providerNames = { 'deepseek': 'DeepSeek', 'doubao': 'è±†åŒ… (Playwright)' };
        document.getElementById('current-provider').textContent = providerNames[selectedProvider] || selectedProvider;

        try {
            const location = document.getElementById('location-select').value || null;
            const res = await fetch('/api/crawler/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_name: jobName,
                    mode: mode,
                    provider: selectedProvider,
                    location: location
                })
            });

            const data = await res.json();
            if (!res.ok) {
                alert('å¯åŠ¨å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            alert('å¯åŠ¨å¤±è´¥: ' + error.message);
        }
    });

    // Stop crawler
    document.getElementById('stop-btn').addEventListener('click', async () => {
        if (!confirm('ç¡®å®šè¦åœæ­¢çˆ¬è™«å—ï¼Ÿ')) return;

        try {
            const res = await fetch('/api/crawler/stop', { method: 'POST' });
            const data = await res.json();
            if (!res.ok) {
                alert('åœæ­¢å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            alert('åœæ­¢å¤±è´¥: ' + error.message);
        }
    });

    // Clear logs
    function clearLogs() {
        document.getElementById('log-container').innerHTML =
            '<div class="log-entry text-secondary"><i class="bi bi-check2 me-2"></i>æ—¥å¿—å·²æ¸…ç©º</div>';
    }

    // Add log entry
    function addLog(message) {
        const container = document.getElementById('log-container');
        const entry = document.createElement('div');
        entry.className = 'log-entry';

        if (message.includes('âœ“') || message.includes('æˆåŠŸ') || message.includes('å®Œæˆ')) {
            entry.classList.add('success');
        } else if (message.includes('âœ—') || message.includes('å¤±è´¥') || message.includes('é”™è¯¯')) {
            entry.classList.add('error');
        }

        entry.textContent = message;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
    }

    // Socket events
    socket.on('connect', () => {
        console.log('Connected to server');
    });

    socket.on('status', (data) => {
        updateUI(data.running);
        if (data.running) {
            document.getElementById('current-job').textContent = data.current_job || '-';
            document.getElementById('current-keyword').textContent = data.current_keyword || '-';
            document.getElementById('progress-text').textContent = `${data.progress} / ${data.total}`;
            document.getElementById('success-count').textContent = data.success_count;
            document.getElementById('fail-count').textContent = data.fail_count;

            const percentage = data.total > 0 ? Math.round(data.progress / data.total * 100) : 0;
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-percentage').textContent = percentage + '%';

            if (data.provider) {
                const providerNames = { 'deepseek': 'DeepSeek', 'doubao': 'è±†åŒ… (Playwright)' };
                document.getElementById('current-provider').textContent = providerNames[data.provider] || data.provider;
            }
        }
    });

    socket.on('progress', (data) => {
        document.getElementById('current-keyword').textContent = data.keyword;
        document.getElementById('progress-text').textContent = `${data.current} / ${data.total}`;
        document.getElementById('success-count').textContent = data.success;
        document.getElementById('fail-count').textContent = data.fail;
        document.getElementById('progress-bar').style.width = data.percentage + '%';
        document.getElementById('progress-percentage').textContent = data.percentage + '%';
    });

    socket.on('log', (data) => {
        addLog(data.message);
    });

    socket.on('crawler_finished', (data) => {
        updateUI(false);
        addLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        addLog('ğŸ‰ çˆ¬è™«è¿è¡Œå®Œæˆï¼');
    });

    // Check initial status
    async function checkStatus() {
        try {
            const res = await fetch('/api/crawler/status');
            const data = await res.json();
            updateUI(data.running);
            if (data.running) {
                document.getElementById('current-job').textContent = data.current_job || '-';
                if (data.provider) {
                    const providerNames = { 'deepseek': 'DeepSeek', 'doubao': 'è±†åŒ… (Playwright)' };
                    document.getElementById('current-provider').textContent = providerNames[data.provider] || data.provider;
                }
            }
        } catch (error) {
            console.error('Failed to check status:', error);
        }
    }

    // Initial load
    loadJobsSelect();
    checkStatus();
</script>
{% endblock %}
