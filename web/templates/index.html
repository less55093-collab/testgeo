{% extends "base.html" %}

{% block title %}仪表盘 - AI Crawler{% endblock %}

{% block content %}
<div class="page-header fade-in-up">
    <h1 class="page-title">仪表盘</h1>
    <p class="page-subtitle">AI 排名爬虫系统概览 · 支持多平台智能分析</p>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3 fade-in-up" style="animation-delay: 0.1s;">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="stat-value" id="total-jobs">-</div>
            <div class="stat-label">任务总数</div>
            <i class="bi bi-folder2-open"
                style="position: absolute; right: 20px; top: 20px; font-size: 48px; opacity: 0.2;"></i>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 fade-in-up" style="animation-delay: 0.15s;">
        <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="stat-value" id="total-runs">-</div>
            <div class="stat-label">运行次数</div>
            <i class="bi bi-play-circle"
                style="position: absolute; right: 20px; top: 20px; font-size: 48px; opacity: 0.2;"></i>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 fade-in-up" style="animation-delay: 0.2s;">
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-value" id="total-keywords">-</div>
            <div class="stat-label">关键词总数</div>
            <i class="bi bi-search"
                style="position: absolute; right: 20px; top: 20px; font-size: 48px; opacity: 0.2;"></i>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 fade-in-up" style="animation-delay: 0.25s;">
        <div class="stat-card" style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">
            <div class="stat-value" id="crawler-status" style="font-size: 32px;">空闲</div>
            <div class="stat-label">爬虫状态</div>
            <i class="bi bi-robot"
                style="position: absolute; right: 20px; top: 20px; font-size: 48px; opacity: 0.2;"></i>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row g-4 mb-4">
    <div class="col-lg-6 fade-in-up" style="animation-delay: 0.3s;">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-lightning-charge-fill me-2" style="font-size: 20px; color: var(--warning-color);"></i>
                <h5 class="mb-0" style="font-weight: 600; color: #ffffff;">快捷操作</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="/jobs" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>创建新任务
                    </a>
                    <a href="/crawler" class="btn btn-success btn-lg">
                        <i class="bi bi-play-fill me-2"></i>启动爬虫
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 fade-in-up" style="animation-delay: 0.35s;">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-cpu-fill me-2" style="font-size: 20px; color: var(--info-color);"></i>
                <h5 class="mb-0" style="font-weight: 600; color: #ffffff;">已配置 AI 平台</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="p-3 rounded-3 d-flex align-items-center"
                            style="background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.2);">
                            <div class="me-3"
                                style="width: 40px; height: 40px; border-radius: 10px; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-robot text-white"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 14px;color: #ffffff;">DeepSeek</div>
                                <div id="deepseek-config-status" class="text-secondary" style="font-size: 12px;">检查中...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 rounded-3 d-flex align-items-center"
                            style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div class="me-3"
                                style="width: 40px; height: 40px; border-radius: 10px; background: var(--secondary-gradient); display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-lightning-charge text-white"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 14px;color:#ffffff">豆包 <span
                                        class="feature-badge" style="font-size: 9px; padding: 2px 6px;"><i
                                            class="bi bi-display"></i></span>
                                </div>
                                <div id="doubao-config-status" class="text-secondary" style="font-size: 12px;">检查中...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
                    <div class="d-flex align-items-center text-secondary" style="font-size: 13px;">
                        <i class="bi bi-info-circle me-2"></i>
                        <span>豆包通过 Playwright 控制浏览器，可获取页面原生参考资料</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Jobs -->
<div class="card fade-in-up" style="animation-delay: 0.4s;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-history me-2" style="font-size: 20px; color: var(--accent-color);"></i>
            <h5 class="mb-0" style="font-weight: 600; color: #ffffff;">最近任务</h5>
        </div>
        <a href="/jobs" class="btn btn-sm btn-outline-light">
            <i class="bi bi-arrow-right me-1"></i>查看全部
        </a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>任务名称</th>
                        <th>关键词数</th>
                        <th>目标产品</th>
                        <th>运行次数</th>
                        <th>最后运行</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="jobs-table">
                    <tr>
                        <td colspan="6" class="text-center text-secondary py-5">
                            <i class="bi bi-hourglass-split me-2"></i>加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Load dashboard data
    async function loadDashboard() {
        try {
            // Load jobs
            const jobsRes = await fetch('/api/jobs');
            const jobs = await jobsRes.json();

            // Update stats
            document.getElementById('total-jobs').textContent = jobs.length;

            let totalRuns = 0;
            let totalKeywords = 0;
            jobs.forEach(job => {
                totalRuns += job.runs_count || 0;
                totalKeywords += job.keywords_count || 0;
            });

            document.getElementById('total-runs').textContent = totalRuns;
            document.getElementById('total-keywords').textContent = totalKeywords;

            // Update jobs table
            const tbody = document.getElementById('jobs-table');
            if (jobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-secondary py-5">
                            <i class="bi bi-folder2 me-2" style="font-size: 24px;"></i>
                            <div class="mt-2">暂无任务</div>
                            <a href="/jobs" class="btn btn-sm btn-primary mt-3">
                                <i class="bi bi-plus-lg me-1"></i>创建第一个任务
                            </a>
                        </td>
                    </tr>`;
            } else {
                tbody.innerHTML = jobs.slice(0, 5).map(job => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${job.name}</div>
                        </td>
                        <td>
                            <span class="badge-status badge-info">${job.keywords_count}</span>
                        </td>
                        <td>${job.target_product || '<span class="text-secondary">-</span>'}</td>
                        <td>${job.runs_count}</td>
                        <td>${job.last_run ? job.last_run.run_id : '<span class="text-secondary">-</span>'}</td>
                        <td>
                            ${job.last_run && job.last_run.status === 'completed' ?
                        `<a href="/report/${job.name}/${job.last_run.run_id}" class="btn btn-sm btn-outline-light">
                                        <i class="bi bi-file-earmark-text"></i> 报告
                                    </a>` : '<span class="text-secondary">-</span>'}
                        </td>
                    </tr>
                `).join('');
            }

            // Load config
            const configRes = await fetch('/api/config');
            const config = await configRes.json();

            // Update provider status
            const providers = config.providers || {};

            const deepseekStatus = document.getElementById('deepseek-config-status');
            if (providers.deepseek?.has_accounts) {
                deepseekStatus.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>已配置</span>';
            } else {
                deepseekStatus.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>未配置</span>';
            }

            const doubaoStatus = document.getElementById('doubao-config-status');
            if (providers.doubao?.has_accounts) {
                doubaoStatus.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>已配置</span>';
            } else {
                doubaoStatus.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>未配置</span>';
            }

            // Load crawler status
            const statusRes = await fetch('/api/crawler/status');
            const status = await statusRes.json();
            const crawlerStatus = document.getElementById('crawler-status');
            if (status.running) {
                crawlerStatus.innerHTML = '<span class="pulse">运行中</span>';
            } else {
                crawlerStatus.textContent = '空闲';
            }

        } catch (error) {
            console.error('Failed to load dashboard:', error);
        }
    }

    // Add number animation
    function animateNumber(element, target) {
        const duration = 1000;
        const start = 0;
        const startTime = performance.now();

        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const current = Math.floor(start + (target - start) * easeOutQuart);
            element.textContent = current;

            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }

        requestAnimationFrame(update);
    }

    // Initial load
    loadDashboard();

    // Auto refresh every 10 seconds
    setInterval(loadDashboard, 10000);
</script>
{% endblock %}
